<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台越學習助手 (Taiwan-Vietnam Learning Assistant)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Noto+Serif+TC:wght@500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        
        /* Custom Scrollbar for nicer look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e7e5e4; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #d6d3d1; }

        /* Animation Keyframes */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
        .slide-in-from-bottom-8 { animation: slideUp 0.7s ease-out forwards; }
        .slide-in-from-top-4 { animation: slideUp 0.5s ease-out forwards; } /* Reusing slideUp logic slightly modified in css if needed, or just relying on simple fade */
        .shake { animation: shake 0.4s ease-in-out; }
    </style>
</head>
<body class="bg-[#F8F9FA] text-stone-800">
    <div id="root"></div>

    <!-- React Application -->
    <script type="module">
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        
        // Import Lucide Icons
        import { 
          Search, Volume2, Copy, Loader2, 
          History, Trash2, CheckCircle, Languages, ExternalLink,
          PenTool, X, ChevronRight, Home, GraduationCap, RefreshCw,
          MonitorPlay, Star, AlertCircle, Layout, ArrowRight, XCircle,
          WifiOff, BrainCircuit, Sparkles, ClipboardCopy, Speaker
        } from 'https://esm.sh/lucide-react@0.292.0';

        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, serverTimestamp, orderBy } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- Init Helper ---
        let dbInstance = null;
        let authInstance = null;
        let appIdVal = 'default-app-id';

        // 模擬環境變數 (在 HTML 版本中通常為空，除非手動填入)
        const __firebase_config = null; // 在此填入 Firebase Config 字串若有需要
        const __initial_auth_token = null;

        try {
            if (__firebase_config) {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                authInstance = getAuth(app);
                dbInstance = getFirestore(app);
            }
        } catch (e) {
            console.error("Firebase init soft fail", e);
        }

        // --- Zhuyin Map ---
        const ZHUYIN_MAP = {
            'ㄅ': '波', 'ㄆ': '坡', 'ㄇ': '摸', 'ㄈ': '佛', 'ㄉ': '得', 'ㄊ': '特', 'ㄋ': '訥', 'ㄌ': '勒',
            'ㄍ': '哥', 'ㄎ': '科', 'ㄏ': '喝', 'ㄐ': '基', 'ㄑ': '七', 'ㄒ': '希', 'ㄓ': '知', 'ㄔ': '吃',
            'ㄕ': '詩', 'ㄖ': '日', 'ㄗ': '資', 'ㄘ': '雌', 'ㄙ': '思', 'ㄧ': '衣', 'ㄨ': '烏', 'ㄩ': '迂',
            'ㄚ': '阿', 'ㄛ': '喔', 'ㄜ': '鵝', 'ㄝ': '耶', 'ㄞ': '哀', 'ㄟ': '欸', 'ㄠ': '凹', 'ㄡ': '歐',
            'ㄢ': '安', 'ㄣ': '恩', 'ㄤ': '骯', 'ㄥ': '亨', 'ㄦ': '兒', 'ㄧㄚ': '呀', 'ㄧㄛ': '優', 'ㄧㄜ': '耶',
            'ㄧㄞ': '崖', 'ㄧㄠ': '妖', 'ㄧㄡ': '憂', 'ㄧㄢ': '煙', 'ㄧㄣ': '因', 'ㄧㄤ': '央', 'ㄧㄥ': '英',
            'ㄨㄚ': '挖', 'ㄨㄛ': '窩', 'ㄨㄞ': '歪', 'ㄨㄟ': '威', 'ㄨㄢ': '彎', 'ㄨㄣ': '溫', 'ㄨㄤ': '汪', 'ㄨㄥ': '翁',
            'ㄩㄝ': '約', 'ㄩㄢ': '冤', 'ㄩㄣ': '暈', 'ㄩㄥ': '庸', 'ˊ': '二聲', 'ˇ': '三聲', 'ˋ': '四聲', '˙': '輕聲'
        };

        const App = () => {
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState(null);
            const [history, setHistory] = useState([]);
            const [flashcards, setFlashcards] = useState([]);
            const [user, setUser] = useState(null);
            const [copied, setCopied] = useState(false);
            const [activeTab, setActiveTab] = useState('home');
            const [isQuizMode, setIsQuizMode] = useState(false);
            const [quizCard, setQuizCard] = useState(null);
            const [quizInput, setQuizInput] = useState('');
            const [quizStatus, setQuizStatus] = useState('idle');
            const [deleteId, setDeleteId] = useState(null);
            const [isOffline, setIsOffline] = useState(!dbInstance);

            // --- Auth & Data ---
            useEffect(() => {
                if (!authInstance) { setIsOffline(true); return; }
                
                const init = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(authInstance, __initial_auth_token);
                    } else {
                    await signInAnonymously(authInstance);
                    }
                } catch(e) { console.error(e); setIsOffline(true); }
                };
                init();
                return onAuthStateChanged(authInstance, setUser);
            }, []);

            useEffect(() => {
                if (!user || !dbInstance) return;
                const unsubH = onSnapshot(query(collection(dbInstance, 'artifacts', appIdVal, 'users', user.uid, 'learning_history'), orderBy('timestamp', 'desc')), s => setHistory(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubF = onSnapshot(query(collection(dbInstance, 'artifacts', appIdVal, 'users', user.uid, 'flashcards'), orderBy('timestamp', 'desc')), s => setFlashcards(s.docs.map(d => ({id:d.id, ...d.data()}))));
                return () => { unsubH(); unsubF(); };
            }, [user]);

            // --- Voice Loading Handling ---
            useEffect(() => {
                const loadVoices = () => {
                window.speechSynthesis.getVoices();
                };
                loadVoices();
                window.speechSynthesis.onvoiceschanged = loadVoices;
            }, []);

            // --- Core Logic ---
            const analyzeText = async (textToAnalyze = input) => {
                const targetText = textToAnalyze || input;
                if (!targetText.trim()) return;
                
                if (textToAnalyze !== input) setInput(targetText);
                
                setActiveTab('home');
                setError(null);
                setLoading(true); 
                window.scrollTo({ top: 0, behavior: 'smooth' });

                const existing = history.find(i => i.original.trim().toLowerCase() === targetText.trim().toLowerCase());
                if (existing) {
                setTimeout(() => {
                    setResult(existing);
                    setLoading(false);
                    setInput(''); 
                }, 600);
                return;
                }

                const apiKey = ""; 
                const prompt = `你是一位專業的台語/國語與越南語雙語老師。請將使用者輸入的內容（越南文或中文）轉換為台灣常用的繁體中文。
重點要求：
1. 必須提供完整的注音符號。
2. 解釋必須精準對應台灣習慣用語。
3. "vocabulary" 欄位中的 "meaning" 必須是「越南文」解釋。
4. 每個單字必須提供 **3個** 常用詞彙 (vocabulary)。
5. 每個單字必須提供一個實用例句。

請嚴格遵守以下 JSON 格式回傳，不要有任何額外文字：
{"original": "原始輸入內容","chinese": "繁體中文翻譯","zhuyin": "全句注音","explanation": "越南文解釋全句意思","characters": [{"char": "漢字","chuHan": "Hán Việt","radical": "部首","decomposition": "拆字","meaning": "該字的越南文詳細解釋","zhuyin": "單字注音","vocabulary": [{"word": "詞彙1", "zhuyin": "注音", "meaning": "詞彙的越南文翻譯"},{"word": "詞彙2", "zhuyin": "注音", "meaning": "詞彙的越南文翻譯"},{"word": "詞彙3", "zhuyin": "注音", "meaning": "詞彙的越南文翻譯"}],"example": {"sentence": "包含該字的中文例句", "zhuyin": "例句注音", "meaning": "例句越南文翻譯"}}]}`;

                try {
                let success = false;
                let resData;
                for (let i = 0; i < 3; i++) {
                    try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: targetText }] }], systemInstruction: { parts: [{ text: prompt }] }, generationConfig: { responseMimeType: "application/json" } })
                    });
                    if (res.ok) { 
                        resData = await res.json();
                        success = true; 
                        break; 
                    }
                    } catch(e) {}
                    await new Promise(r => setTimeout(r, 1000));
                }

                if (!success || !resData) throw new Error("Kết nối thất bại (Connection Failed)");
                
                const rawText = resData.candidates?.[0]?.content?.parts?.[0]?.text?.replace(/```json/g, '').replace(/```/g, '').trim();
                const parsed = JSON.parse(rawText);
                setResult(parsed);
                setInput(''); 

                if (!isOffline && user && dbInstance) {
                    addDoc(collection(dbInstance, 'artifacts', appIdVal, 'users', user.uid, 'learning_history'), { ...parsed, timestamp: serverTimestamp() });
                } else {
                    setHistory(prev => [{...parsed, id: Date.now().toString()}, ...prev]);
                }
                } catch (err) {
                setError(err.message);
                } finally {
                setLoading(false);
                }
            };

            const speak = (text) => {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                
                // 預處理文字，處理注音符號
                let txt = (text && text.length <= 2 && ZHUYIN_MAP[text]) ? ZHUYIN_MAP[text] : text;
                if (!txt) return;

                const u = new SpeechSynthesisUtterance(txt);
                
                // --- 優化點：智慧語速 ---
                // 單字/短詞 (<=3字) 讀慢一點，清楚展示發音
                // 長句子 (>3字) 讀稍微快一點，模擬自然說話流暢度
                const isShort = txt.length <= 3;
                u.rate = isShort ? 0.65 : 0.85; 
                
                // --- 優化點：聲音質感 ---
                u.pitch = 1.05; // 稍微調高一點點音調，通常聽起來比較清晰愉悅
                u.volume = 1.0;
                u.lang = 'zh-TW';

                const voices = window.speechSynthesis.getVoices();
                
                // 語音選擇邏輯 (優先順序不變，但確保選到最佳體驗)
                const targetVoice = 
                voices.find(v => v.name.includes('Meijia') || v.name.includes('美佳')) ||
                voices.find(v => v.name.includes('HsiaoChen') || v.name.includes('曉臻')) ||
                voices.find(v => v.name.includes('Yating') || v.name.includes('雅婷')) ||
                voices.find(v => v.name.includes('Google') && v.lang.includes('zh-TW')) ||
                voices.find(v => v.lang === 'zh-TW');

                if (targetVoice) {
                u.voice = targetVoice;
                }

                window.speechSynthesis.speak(u);
            };

            const toggleCard = async (char, e) => {
                // Fix: 停止事件冒泡，防止點擊星星時觸發其他卡片行為
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                const exist = flashcards.find(f => f.char === char.char);

                // Fix: 離線或無使用者時，操作本地狀態
                if (isOffline || !user) {
                    if (exist) {
                        setFlashcards(prev => prev.filter(f => f.char !== char.char));
                    } else {
                        setFlashcards(prev => [{ ...char, id: `local_${Date.now()}` }, ...prev]);
                    }
                    return;
                }

                // 線上模式
                try {
                    if (exist) await deleteDoc(doc(dbInstance, 'artifacts', appIdVal, 'users', user.uid, 'flashcards', exist.id));
                    else await addDoc(collection(dbInstance, 'artifacts', appIdVal, 'users', user.uid, 'flashcards'), { ...char, timestamp: serverTimestamp() });
                } catch(err) {
                    console.error("DB Error", err);
                    // 如果DB失敗，嘗試本地更新以保持UI響應
                    if (exist) {
                        setFlashcards(prev => prev.filter(f => f.char !== char.char));
                    } else {
                        setFlashcards(prev => [{ ...char, id: `local_${Date.now()}` }, ...prev]);
                    }
                }
            };

            const openQuiz = (card) => {
                setQuizCard(card);
                setQuizInput('');
                setQuizStatus('idle');
                setIsQuizMode(true);
            };

            const checkAns = () => {
                if (!quizCard) return;
                const isCorrect = quizInput.replace(/\s/g,'') === quizCard.zhuyin.replace(/\s/g,'');
                setQuizStatus(isCorrect ? 'correct' : 'wrong');
                speak(isCorrect ? "答對了" : "再試一次");
            };

            const delHistory = async () => {
                if (!deleteId) { setDeleteId(null); return; }
                
                // Fix: 離線刪除
                if (isOffline || !user) {
                     setHistory(prev => prev.filter(item => item.id !== deleteId));
                     setDeleteId(null);
                     return;
                }

                try {
                    await deleteDoc(doc(dbInstance, 'artifacts', appIdVal, 'users', user.uid, 'learning_history', deleteId));
                } catch(err) {
                    // Fallback local delete
                    setHistory(prev => prev.filter(item => item.id !== deleteId));
                }
                setDeleteId(null);
            };

            const copyResult = () => {
                if (!result) return;
                const text = `${result.chinese}\n${result.zhuyin}\n${result.explanation}`;
                navigator.clipboard.writeText(text);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            // --- Sub-Components ---
            const ZhuyinBtn = ({ t }) => {
                const chars = t?.replace(/\s/g,'').split('') || [];
                return React.createElement('div', { className: "flex flex-wrap gap-2 mt-2" },
                    chars.map((c, i) => React.createElement('button', {
                        key: i,
                        onClick: (e) => { e.stopPropagation(); speak(c); },
                        className: "w-12 h-12 bg-white border border-stone-200/60 rounded-2xl text-stone-700 text-xl font-bold hover:bg-stone-800 hover:text-white hover:border-stone-800 hover:-translate-y-1 hover:shadow-lg active:scale-95 transition-all duration-300 flex items-center justify-center"
                    }, c))
                );
            };

            const Skeleton = () => (
                React.createElement('div', { className: "space-y-8 animate-pulse" },
                    React.createElement('div', { className: "bg-white/80 backdrop-blur-md rounded-[2.5rem] p-10 shadow-[0_20px_50px_-12px_rgba(0,0,0,0.1)] border border-white/50 h-72 flex flex-col items-center justify-center gap-6" },
                        React.createElement(Loader2, { className: "w-12 h-12 text-stone-300 animate-spin" }),
                        React.createElement('div', { className: "h-4 w-40 bg-stone-100/80 rounded-full" })
                    ),
                    React.createElement('div', { className: "bg-white/60 rounded-[2.5rem] h-56 border border-white/50" })
                )
            );

            // --- Main Render ---
            return React.createElement('div', { className: "min-h-screen bg-[#F8F9FA] text-stone-800 font-sans pb-40 overflow-x-hidden selection:bg-stone-200" },
                // Background
                React.createElement('div', { className: "fixed inset-0 z-0 pointer-events-none" },
                    React.createElement('div', { className: "absolute top-[-20%] left-[-10%] w-[70%] h-[70%] bg-blue-50/40 rounded-full blur-[120px]" }),
                    React.createElement('div', { className: "absolute bottom-[-10%] right-[-10%] w-[60%] h-[60%] bg-purple-50/40 rounded-full blur-[100px]" })
                ),
                
                // Header
                React.createElement('header', { className: "fixed top-0 inset-x-0 z-40 bg-[#F8F9FA]/90 backdrop-blur-2xl border-b border-white/40 py-3 px-4 shadow-[0_4px_30px_rgba(0,0,0,0.03)] safe-top transition-all duration-500" },
                    React.createElement('div', { className: "max-w-2xl mx-auto flex items-center justify-between" },
                        React.createElement('div', { 
                            className: "flex items-center gap-3 cursor-pointer group",
                            onClick: () => speak("台越學習助手"),
                            title: "Nghe phát âm tên App"
                        },
                            React.createElement('div', { className: "bg-stone-900 text-white p-2.5 rounded-2xl shadow-xl shadow-stone-200 group-hover:scale-105 group-active:scale-95 transition-transform duration-300" }, React.createElement(Languages, { size: 22 })),
                            React.createElement('div', null,
                                React.createElement('h1', { className: "font-bold text-stone-900 leading-none text-lg tracking-tight group-hover:text-blue-600 transition-colors duration-300" }, "Trợ lý tiếng Đài"),
                                React.createElement('span', { className: "text-[10px] text-stone-400 font-bold tracking-widest uppercase" }, "TW-VN AI")
                            )
                        ),
                        React.createElement('div', { className: "flex bg-white/80 backdrop-blur p-1.5 rounded-full shadow-[0_4px_20px_rgba(0,0,0,0.04)] border border-white" },
                            [{id:'home',l:'Dịch'},{id:'practice',l:'Từ vựng',c:flashcards.length},{id:'history',l:'Lịch sử'}].map(t => 
                                React.createElement('button', {
                                    key: t.id,
                                    onClick: () => setActiveTab(t.id),
                                    className: `px-5 py-2 rounded-full text-xs font-bold transition-all duration-300 relative active:scale-95 ${activeTab===t.id?'bg-stone-900 text-white shadow-lg':'text-stone-400 hover:bg-stone-100/50 hover:text-stone-600'}`
                                }, t.l, t.c > 0 && activeTab !== t.id && React.createElement('span', { className: "absolute top-1 right-2 w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse" }))
                            )
                        )
                    )
                ),

                // Main Content
                React.createElement('main', { className: "max-w-2xl mx-auto px-4 pt-28 space-y-8 relative z-10 safe-bottom" },
                    
                    // Home Tab
                    activeTab === 'home' && React.createElement('div', { className: "space-y-8" },
                        React.createElement('div', { className: "relative z-20 bg-white/80 backdrop-blur-xl rounded-[2.5rem] p-3 flex gap-3 shadow-[0_20px_50px_-12px_rgba(0,0,0,0.08)] border border-white ring-1 ring-white/50 group hover:shadow-[0_30px_60px_-12px_rgba(0,0,0,0.12)] transition-all duration-500 hover:-translate-y-0.5" },
                            React.createElement('div', { className: "flex-1 relative flex items-center" },
                                React.createElement('input', {
                                    type: "text",
                                    className: "w-full bg-transparent pl-6 pr-12 py-4 text-xl outline-none font-medium text-stone-800 placeholder:text-stone-300",
                                    placeholder: "Nhập văn bản...",
                                    value: input,
                                    onChange: e => setInput(e.target.value),
                                    onKeyDown: e => e.key === 'Enter' && analyzeText()
                                }),
                                input && React.createElement('button', {
                                    onClick: () => setInput(''),
                                    className: "absolute right-2 p-2 text-stone-300 hover:text-stone-500 hover:bg-stone-100 rounded-full transition-all duration-300 active:scale-90"
                                }, React.createElement(XCircle, { size: 22 }))
                            ),
                            React.createElement('button', {
                                onClick: () => analyzeText(),
                                disabled: loading,
                                className: "bg-stone-900 text-white px-8 h-16 rounded-[2rem] flex items-center justify-center gap-2 shadow-xl hover:shadow-2xl hover:bg-black hover:scale-[1.02] active:scale-95 disabled:bg-stone-200 disabled:shadow-none disabled:scale-100 transition-all duration-300 shrink-0 ease-out"
                            }, loading ? React.createElement(Loader2, { className: "animate-spin", size: 24 }) : React.createElement(React.Fragment, null, React.createElement('span', { className: "font-bold text-lg" }, "Dịch"), React.createElement(ArrowRight, { size: 24 })))
                        ),

                        error && React.createElement('div', { className: "bg-red-50/80 backdrop-blur-md border border-red-100/50 text-red-600 p-5 rounded-[2rem] flex items-center gap-3 text-sm font-bold shadow-lg animate-in fade-in slide-in-from-top-4 duration-500" }, React.createElement(AlertCircle, { size: 20 }), error),

                        loading ? React.createElement(Skeleton) : result ? React.createElement('div', { className: "space-y-8 animate-in fade-in slide-in-from-bottom-8 duration-700" },
                            // Result Card
                            React.createElement('div', { className: "bg-white/95 backdrop-blur rounded-[3rem] p-10 shadow-[0_30px_80px_-20px_rgba(0,0,0,0.08)] border border-white relative overflow-hidden group hover:shadow-[0_40px_90px_-20px_rgba(0,0,0,0.12)] transition-shadow duration-700" },
                                React.createElement('div', { className: "absolute top-0 right-0 w-40 h-40 bg-gradient-to-br from-stone-50 to-stone-100 rounded-bl-[100px] -mr-12 -mt-12 transition-transform group-hover:scale-110 duration-700 ease-out" }),
                                React.createElement('div', { className: "flex justify-between items-start mb-8 relative z-10" },
                                    React.createElement('span', { className: "text-[10px] font-bold text-stone-400 uppercase tracking-[0.2em] border border-stone-100 px-4 py-1.5 rounded-full bg-white/80 backdrop-blur" }, "Kết quả"),
                                    React.createElement('button', {
                                        onClick: copyResult,
                                        className: "flex items-center gap-2 text-stone-400 hover:text-stone-900 bg-white p-2 pr-4 rounded-full shadow-sm border border-stone-100 hover:shadow-md transition-all active:scale-95 duration-300"
                                    }, copied ? React.createElement(CheckCircle, { size: 20, className: "text-green-500" }) : React.createElement(ClipboardCopy, { size: 20 }), React.createElement('span', { className: "text-xs font-bold" }, "Sao chép"))
                                ),
                                React.createElement('div', { className: "relative z-10 text-center" },
                                    React.createElement('div', { className: "text-xl text-stone-400 font-mono mb-4 tracking-widest" }, result.zhuyin),
                                    React.createElement('h2', {
                                        onClick: () => speak(result.chinese),
                                        className: "text-7xl font-black text-stone-900 cursor-pointer hover:text-stone-600 transition-colors mb-8 select-none tracking-tight active:scale-95 duration-200"
                                    }, result.chinese),
                                    React.createElement('div', { className: "inline-block px-8 py-4 bg-stone-50/50 rounded-3xl text-stone-600 text-lg font-medium italic border border-stone-100 shadow-inner backdrop-blur-sm" }, `"${result.explanation}"`)
                                ),
                                React.createElement('div', { className: "mt-10 relative z-10 flex justify-center" },
                                    React.createElement('button', {
                                        onClick: () => speak(result.chinese),
                                        className: "bg-stone-900 text-white px-8 py-4 rounded-[2rem] font-bold flex items-center gap-3 shadow-xl hover:shadow-2xl hover:-translate-y-1 active:scale-95 transition-all duration-300"
                                    }, React.createElement(Volume2, { size: 20 }), " Nghe phát âm")
                                )
                            ),

                            // Characters
                            React.createElement('div', { className: "grid gap-8" },
                                result.characters?.map((c, i) => React.createElement('div', { key: i, className: "bg-white/80 backdrop-blur-md rounded-[2.5rem] p-10 border border-white shadow-[0_20px_40px_-15px_rgba(0,0,0,0.04)] hover:shadow-[0_30px_60px_-15px_rgba(0,0,0,0.08)] transition-all duration-500 group" },
                                    React.createElement('div', { className: "flex flex-col sm:flex-row gap-10 border-b border-stone-100 pb-10 mb-10" },
                                        React.createElement('div', { className: "relative self-center" },
                                            React.createElement('div', {
                                                onClick: () => speak(c.char),
                                                className: "w-36 h-36 bg-[#FAFAFA] rounded-[2.5rem] flex items-center justify-center text-8xl font-serif font-bold text-stone-800 cursor-pointer hover:bg-stone-900 hover:text-white transition-all duration-500 shadow-[inset_0_2px_10px_rgba(0,0,0,0.02)] relative overflow-hidden group/char active:scale-95"
                                            }, React.createElement('span', { className: "relative z-10" }, c.char)),
                                            React.createElement('button', {
                                                onClick: (e) => toggleCard(c, e), // Fix: 傳遞事件 e
                                                className: `absolute -top-3 -right-3 p-3 rounded-full shadow-lg border-4 border-white transition-all duration-300 ${flashcards.find(f=>f.char===c.char)?'bg-yellow-400 text-white rotate-12 scale-110':'bg-white text-stone-200 hover:text-yellow-400'} active:scale-90`
                                            }, React.createElement(Star, { size: 20, fill: "currentColor" }))
                                        ),
                                        React.createElement('div', { className: "flex-1 space-y-6" },
                                            React.createElement('div', null,
                                                React.createElement('div', { className: "text-[10px] font-bold text-stone-300 uppercase tracking-widest mb-1" }, "Phát âm (Zhuyin)"),
                                                React.createElement(ZhuyinBtn, { t: c.zhuyin })
                                            ),
                                            React.createElement('div', { className: "flex flex-wrap gap-3" },
                                                React.createElement('div', { className: "flex flex-col" },
                                                    React.createElement('span', { className: "text-[10px] text-stone-400 font-bold uppercase" }, "Hán Việt"),
                                                    React.createElement('span', { className: "text-sm font-bold text-stone-800 bg-stone-100 px-3 py-1 rounded-lg mt-1" }, c.chuHan)
                                                ),
                                                React.createElement('div', { className: "flex flex-col" },
                                                    React.createElement('span', { className: "text-[10px] text-stone-400 font-bold uppercase" }, "Bộ thủ"),
                                                    React.createElement('span', { className: "text-sm font-bold text-stone-800 bg-stone-100 px-3 py-1 rounded-lg mt-1" }, c.radical)
                                                )
                                            ),
                                            React.createElement('p', { className: "text-base text-stone-600 font-medium leading-relaxed border-l-2 border-stone-200 pl-4" }, c.meaning)
                                        )
                                    ),
                                    React.createElement('div', { className: "grid sm:grid-cols-2 gap-8" },
                                        React.createElement('div', { className: "space-y-4" },
                                            React.createElement('div', { className: "text-[10px] font-bold text-stone-400 uppercase tracking-widest flex items-center gap-2" }, React.createElement('span', { className: "w-1.5 h-1.5 bg-stone-800 rounded-full" }), " Từ vựng"),
                                            c.vocabulary?.map((v, vi) => React.createElement('div', { key: vi, className: "flex justify-between items-center p-4 rounded-2xl bg-stone-50/50 hover:bg-white hover:shadow-[0_10px_30px_-10px_rgba(0,0,0,0.08)] transition-all duration-300 border border-transparent hover:border-stone-100 group/vocab" },
                                                React.createElement('div', { className: "flex-1 cursor-pointer", onClick: () => speak(v.word) },
                                                    React.createElement('div', { className: "flex items-center gap-2" },
                                                        React.createElement('span', { className: "font-bold text-stone-800 text-lg group-hover/vocab:text-stone-600 transition-colors duration-300" }, v.word),
                                                        React.createElement('span', { className: "text-[10px] font-normal text-stone-400 bg-white px-2 py-1 rounded-lg border border-stone-100" }, v.zhuyin)
                                                    ),
                                                    React.createElement('div', { className: "text-xs text-stone-500 mt-1 font-medium" }, v.meaning)
                                                ),
                                                React.createElement('div', { className: "flex items-center gap-2" },
                                                    React.createElement('button', {
                                                        onClick: (e) => { e.stopPropagation(); analyzeText(v.word); },
                                                        className: "p-2 text-stone-300 hover:text-stone-600 bg-white rounded-full shadow-sm hover:shadow-md transition-all opacity-0 group-hover/vocab:opacity-100 active:scale-95 duration-300",
                                                        title: "Tra từ này"
                                                    }, React.createElement(Search, { size: 16 })),
                                                    React.createElement('button', {
                                                        onClick: (e) => { e.stopPropagation(); speak(v.word); },
                                                        className: "p-2 text-stone-300 hover:text-stone-800 bg-white rounded-full shadow-sm hover:shadow-md transition-all active:scale-95 duration-300"
                                                    }, React.createElement(Volume2, { size: 16 }))
                                                )
                                            ))
                                        ),
                                        c.example && React.createElement('div', {
                                            onClick: () => speak(c.example.sentence),
                                            className: "bg-gradient-to-br from-[#FFFDF5] to-[#FFF9E6] p-6 rounded-[2rem] border border-yellow-100/50 hover:border-yellow-200 hover:shadow-[0_20px_40px_-10px_rgba(255,240,200,0.5)] cursor-pointer transition-all duration-500 group/ex relative overflow-hidden active:scale-95"
                                        },
                                            React.createElement('div', { className: "absolute top-0 right-0 p-4 opacity-10 group-hover/ex:opacity-20 transition-opacity duration-500" }, React.createElement(Sparkles, { size: 48, className: "text-yellow-600" })),
                                            React.createElement('div', { className: "text-[10px] font-bold text-yellow-600/60 uppercase mb-3 flex items-center gap-2 relative z-10" }, React.createElement(Sparkles, { size: 12, className: "fill-current" }), " Ví dụ"),
                                            React.createElement('p', { className: "font-bold text-stone-800 text-xl leading-snug relative z-10" }, c.example.sentence),
                                            React.createElement('div', { className: "flex items-center gap-2 mt-3 relative z-10" },
                                                React.createElement(Volume2, { size: 16, className: "text-yellow-500 opacity-50 group-hover/ex:opacity-100 transition-opacity duration-300" }),
                                                React.createElement('span', { className: "text-xs text-stone-500 font-mono bg-white/60 px-2 py-1 rounded-md" }, c.example.zhuyin)
                                            ),
                                            React.createElement('p', { className: "text-sm text-stone-500 italic mt-2 relative z-10 font-medium" }, c.example.meaning)
                                        )
                                    )
                                ))
                            )
                        ) : React.createElement('div', { className: "text-center py-32 opacity-30 flex flex-col items-center" },
                            React.createElement(Layout, { size: 64, strokeWidth: 0.8, className: "text-stone-300 mb-6" }),
                            React.createElement('h3', { className: "font-bold text-stone-800 text-xl tracking-tight" }, "Sẵn sàng"),
                            React.createElement('p', { className: "text-stone-400 mt-2" }, "Nhập tiếng Việt hoặc Trung")
                        )
                    ),

                    // Practice Tab
                    activeTab === 'practice' && React.createElement('div', { className: "space-y-8 animate-in fade-in slide-in-from-right-8 duration-500" },
                        React.createElement('div', { className: "bg-stone-900 rounded-[2.5rem] p-10 text-white shadow-2xl relative overflow-hidden group" },
                            React.createElement(MonitorPlay, { size: 200, className: "absolute -right-10 -top-10 opacity-10 rotate-12 group-hover:rotate-6 transition-transform duration-700" }),
                            React.createElement('h3', { className: "text-2xl font-bold mb-4 relative z-10 flex items-center gap-3" }, React.createElement('span', { className: "bg-white/20 p-2 rounded-xl" }, React.createElement(MonitorPlay, { size: 20 })), " Tài nguyên mở rộng"),
                            React.createElement('p', { className: "text-stone-400 text-base mb-8 max-w-sm relative z-10 leading-relaxed" }, "Luyện viết và phát âm chuẩn cùng tài nguyên trực tuyến của Hanlin Education."),
                            React.createElement('a', { href: "https://kidsvideo1.hle.com.tw/?utm_source=chatgpt.com", target: "_blank", className: "inline-flex items-center gap-3 bg-white text-black px-8 py-4 rounded-2xl font-bold text-sm hover:bg-stone-200 transition-all shadow-lg hover:shadow-xl active:scale-95 duration-300 relative z-10" }, "Đi tới luyện tập ", React.createElement(ArrowRight, { size: 18 }))
                        ),
                        React.createElement('div', { className: "flex justify-between items-center px-2" },
                            React.createElement('h2', { className: "text-2xl font-bold text-stone-900 flex items-center gap-4" }, React.createElement('div', { className: "bg-stone-100 p-3 rounded-2xl text-stone-500" }, React.createElement(GraduationCap, { size: 24 })), " Từ vựng ", React.createElement('span', { className: "text-sm font-bold bg-white px-3 py-1 rounded-lg border border-stone-200 shadow-sm text-stone-600" }, flashcards.length)),
                            flashcards.length > 0 && React.createElement('button', {
                                onClick: () => { const r = flashcards[Math.floor(Math.random() * flashcards.length)]; openQuiz(r); },
                                className: "bg-stone-900 text-white px-6 py-3 rounded-full text-sm font-bold flex items-center gap-3 hover:bg-black transition-all active:scale-95 shadow-lg duration-300"
                            }, React.createElement(RefreshCw, { size: 18 }), isQuizMode ? 'Câu khác' : 'Kiểm tra')
                        ),
                        isQuizMode && quizCard ? React.createElement('div', { className: "bg-white rounded-[2rem] p-8 border border-stone-100 shadow-[0_25px_60px_-15px_rgba(0,0,0,0.15)] relative text-center max-w-[340px] mx-auto animate-in zoom-in-95 duration-300" },
                            React.createElement('button', { onClick: () => setIsQuizMode(false), className: "absolute top-4 right-4 p-2 bg-stone-50 rounded-full hover:bg-stone-100 transition-colors" }, React.createElement(X, { size: 20 })),
                            React.createElement('div', { className: "text-[10px] font-bold text-stone-300 tracking-[0.3em] mb-4 mt-1" }, "QUIZ MODE"),
                            React.createElement('div', {
                                className: "text-8xl font-serif font-black text-stone-900 mb-3 cursor-pointer hover:text-stone-700 transition-colors active:scale-95 select-none duration-300",
                                onClick: () => speak(quizCard.char),
                                title: "Nghe phát âm"
                            }, quizCard.char),
                            React.createElement('div', { className: "text-lg text-stone-500 font-medium italic mb-6" }, quizCard.meaning),
                            React.createElement('div', { className: "space-y-4" },
                                React.createElement('input', {
                                    type: "text",
                                    value: quizInput,
                                    onChange: e => setQuizInput(e.target.value),
                                    placeholder: "Nhập chú âm...",
                                    className: `w-full text-center text-3xl font-bold py-3 border-b-2 bg-transparent outline-none transition-colors duration-300 ${quizStatus==='correct'?'border-green-500 text-green-600':quizStatus==='wrong'?'border-red-500 text-red-600':'border-stone-100 focus:border-stone-900 text-stone-800'}`
                                }),
                                quizStatus === 'correct' && React.createElement('div', { className: "text-green-600 font-bold flex items-center justify-center gap-2 bg-green-50 py-2 rounded-xl animate-in zoom-in text-sm" }, React.createElement(CheckCircle, { size: 18 }), ` Chính xác! (${quizCard.zhuyin})`),
                                quizStatus === 'wrong' && React.createElement('div', { className: "text-red-500 font-bold flex items-center justify-center gap-2 bg-red-50 py-2 rounded-xl animate-in shake text-sm" }, React.createElement(AlertCircle, { size: 18 }), " Thử lại xem"),
                                React.createElement('button', {
                                    onClick: checkAns,
                                    className: "w-full bg-stone-900 text-white py-3 rounded-2xl font-bold text-base hover:bg-black transition-all shadow-lg hover:shadow-xl active:scale-95 duration-300"
                                }, "Kiểm tra")
                            )
                        ) : flashcards.length === 0 ? React.createElement('div', { className: "text-center py-32 border border-dashed border-stone-200 rounded-[3rem] bg-white/50" }, React.createElement(Star, { size: 40, className: "mx-auto text-stone-300 mb-4" }), React.createElement('p', { className: "text-stone-400 font-medium text-lg" }, "Chưa có từ vựng")) : 
                        React.createElement('div', { className: "grid grid-cols-2 gap-6" },
                            flashcards.map(c => React.createElement('div', { key: c.id, onClick: () => openQuiz(c), className: "bg-white p-8 rounded-[2.5rem] border border-stone-50 shadow-[0_10px_30px_-10px_rgba(0,0,0,0.05)] hover:-translate-y-2 hover:shadow-[0_20px_40px_-10px_rgba(0,0,0,0.1)] transition-all duration-300 cursor-pointer relative group active:scale-95" },
                                React.createElement('button', { onClick: (e) => { e.stopPropagation(); toggleCard(c, e); }, className: "absolute top-6 right-6 text-stone-200 hover:text-red-400 p-2 hover:bg-red-50 rounded-full transition-colors" }, React.createElement(Trash2, { size: 20 })),
                                React.createElement('div', { className: "text-center py-4" },
                                    React.createElement('div', { className: "text-7xl font-serif font-medium text-stone-900 mb-4" }, c.char),
                                    React.createElement('div', { className: "text-sm font-bold text-stone-900 bg-stone-100 px-5 py-2 rounded-full inline-block" }, c.zhuyin),
                                    React.createElement('div', { className: "text-xs text-stone-400 mt-4 border-t border-stone-50 pt-4 w-full font-medium tracking-wide line-clamp-1" }, c.meaning)
                                )
                            ))
                        )
                    ),

                    // History Tab
                    activeTab === 'history' && React.createElement('div', { className: "space-y-8 animate-in fade-in slide-in-from-right-8 duration-500" },
                        history.length === 0 ? React.createElement('div', { className: "text-center py-32 border border-dashed border-stone-200 rounded-[3rem] bg-white/50" }, React.createElement(History, { size: 40, className: "mx-auto text-stone-300 mb-4" }), React.createElement('p', { className: "text-stone-400 font-medium text-lg" }, "Chưa có lịch sử")) :
                        React.createElement('div', { className: "grid gap-6" },
                            history.map(item => React.createElement('div', { key: item.id, onClick: () => setResult(item) || setActiveTab('home'), className: "bg-white p-8 rounded-[2rem] border border-stone-50 shadow-sm hover:shadow-[0_20px_40px_-15px_rgba(0,0,0,0.08)] cursor-pointer flex justify-between items-center group relative transition-all active:scale-95 duration-300" },
                                React.createElement('div', { className: "pl-4" },
                                    React.createElement('span', { className: "text-sm font-bold text-stone-400 bg-stone-50 px-3 py-1 rounded-lg font-mono mb-3 inline-block tracking-wider" }, item.zhuyin),
                                    React.createElement('div', { className: "font-black text-stone-900 text-4xl mb-3 leading-snug" }, item.chinese),
                                    React.createElement('div', { className: "text-sm text-stone-500 truncate max-w-[200px] font-medium bg-stone-50 inline-block px-3 py-1 rounded-full" }, item.original)
                                ),
                                React.createElement('div', { className: "flex gap-3 relative z-20 opacity-0 group-hover:opacity-100 transition-opacity duration-300" },
                                    React.createElement('button', { onClick: (e) => { e.stopPropagation(); speak(item.chinese); }, className: "p-4 text-stone-400 hover:text-black hover:bg-stone-100 rounded-2xl transition-colors" }, React.createElement(Volume2, { size: 24 })),
                                    React.createElement('button', { onClick: (e) => { e.stopPropagation(); setDeleteId(item.id); }, className: "p-4 text-stone-300 hover:text-red-600 hover:bg-red-50 rounded-2xl transition-colors" }, React.createElement(Trash2, { size: 24 }))
                                )
                            ))
                        )
                    ),

                    // Delete Modal
                    deleteId && React.createElement('div', { className: "fixed inset-0 z-50 flex items-center justify-center p-4 bg-white/80 backdrop-blur-md animate-in fade-in duration-300" },
                        React.createElement('div', { className: "bg-white rounded-[2.5rem] p-10 w-full max-w-sm shadow-[0_40px_100px_-20px_rgba(0,0,0,0.2)] border border-stone-100 scale-100 animate-in zoom-in-95 duration-300" },
                            React.createElement('h3', { className: "text-2xl font-black text-stone-900 mb-4" }, "Xác nhận xóa?"),
                            React.createElement('p', { className: "text-stone-500 mb-10 font-medium leading-relaxed" }, "Hành động này không thể hoàn tác."),
                            React.createElement('div', { className: "flex gap-4 justify-end" },
                                React.createElement('button', { onClick: () => setDeleteId(null), className: "px-8 py-4 rounded-2xl font-bold text-stone-600 hover:bg-stone-50 transition-colors active:scale-95 duration-200" }, "Hủy"),
                                React.createElement('button', { onClick: delHistory, className: "px-8 py-4 rounded-2xl bg-stone-900 text-white font-bold hover:bg-black shadow-xl transition-all active:scale-95 duration-200" }, "Xóa ngay")
                            )
                        )
                    )
                )
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
