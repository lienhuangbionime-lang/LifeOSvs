name: Process Journal Entry

on:
  repository_dispatch:
    types: [new_journal_entry]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout content
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas pyarrow python-frontmatter requests google-generativeai

    # 1. å¤§è…¦ï¼šæ¥æ”¶ Zapier è³‡æ–™ -> Gemini åˆ†æ -> ç”¢å‡º Inbox (JSON+MD)
    - name: Run Neural Classifier (Inbox Generation)
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        JOURNAL_TEXT: ${{ github.event.client_payload.text }}
      run: |
        python src/actions/process_inbox.py

    # 2. æ‰‹è¡“åˆ€ï¼šè®€å– Inbox -> æ‹†åˆ† Project/Life -> æå– Next Steps
    - name: Run Dual-Track Splitter (Auto-Classification)
      run: |
        python src/actions/classify_inbox.py

    # 3. å‚³ä»¤å…µï¼šè®€å– Next Steps -> ç™¼é€ Telegram
    - name: Nudge Next Actions via Telegram
      env:
        TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TG_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        import os
        import json
        import requests

        status_file = "data/status/latest_actions.json"
        
        if os.path.exists(status_file) and os.getenv("TG_TOKEN"):
            with open(status_file, 'r') as f:
                actions_map = json.load(f)
            
            if actions_map:
                msg_lines = ["ğŸš€ **Project Update Confirmed**", ""]
                for proj, data in actions_map.items():
                    msg_lines.append(f"ğŸ“‚ *{proj}* ({data['date']})")
                    for action in data['actions']:
                        msg_lines.append(f"â€¢ {action}")
                    msg_lines.append("")
                
                msg_lines.append("Next step captured. Keep moving.")
                message = "\n".join(msg_lines)
                
                url = f"https://api.telegram.org/bot{os.environ['TG_TOKEN']}/sendMessage"
                payload = {
                    "chat_id": os.environ['TG_CHAT_ID'],
                    "text": message,
                    "parse_mode": "Markdown"
                }
                try:
                    requests.post(url, json=payload)
                    print("âœ… Telegram Nudge Sent")
                except Exception as e:
                    print(f"âŒ Telegram Fail: {e}")
        else:
            print("No actions to nudge or tokens missing.")
      shell: python

    # 4. å£“ç¸®æ©Ÿï¼šInbox -> Parquet/Archive -> æ¸…ç©º Inbox
    - name: Run compaction script
      run: python src/actions/compact_inbox.py

    # 5. å­˜æª”ï¼šä¸€æ¬¡æäº¤æ‰€æœ‰è®Šæ›´ (åŒ…å« Inbox æš«å­˜, Status, Projects, Life, Archive)
    - name: Commit and push changes
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ğŸ¤– LifeOS: Organized Entry & Nudge Sent"
        file_pattern: "data/*"
