name: Process Journal Entry

on:
  repository_dispatch:
    types: [new_journal_entry]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout content
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install pandas pyarrow python-frontmatter google-generativeai google-api-python-client google-auth-httplib2 google-auth-oauthlib

    # 1. å¤§è…¦è§£æ (ç”Ÿæˆ Inbox åŸå­æª”æ¡ˆ)
    - name: Run Neural Brain (Process Inbox)
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        JOURNAL_TEXT: ${{ github.event.client_payload.text }}
      run: python src/actions/process_inbox.py

    # 2. è‡ªå‹•åˆ†æµ (æ­¸æª”åˆ° Project/Life è³‡æ–™å¤¾)
    - name: Run Splitter (Classify)
      run: python src/actions/classify_inbox.py

    # 3. [NEW] ç”¢ç”Ÿ Google Tasks å¾…è¾¦äº‹é … (Nudge)
    - name: Sync to Google Tasks
      env:
        GOOGLE_TASKS_CREDS: ${{ secrets.GOOGLE_TASKS_CREDS }} # éœ€åœ¨ GitHub Secrets è¨­å®š
        TASK_LIST_ID: ${{ secrets.TASK_LIST_ID }} # ä½ çš„ Task List ID
      run: python src/actions/push_tasks.py

    # 4. [NEW] ç”Ÿæˆå°ˆæ¡ˆæˆ°æƒ…å ±å‘Š (Project Report)
    - name: Generate Project Report
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: python src/actions/generate_report.py

    # 5. å£“ç¸®èˆ‡æ¸…ç† (ç¶­è­·è³‡æ–™åº«)
    - name: Run Compaction (Database Maintenance)
      run: python src/actions/compact_inbox.py

    # 6. ä¸€æ¬¡æ€§æäº¤æ‰€æœ‰è®Šæ›´
    - name: Commit and Push
      run: |
        git config --global user.name "LifeOS Bot"
        git config --global user.email "bot@lifeos.ai"
        git add data/
        git commit -m "ğŸ§  Neural Process: Analysis, Tasks & Reporting Complete" || exit 0
        git pull --rebase origin main
        git push
