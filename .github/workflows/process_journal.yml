name: Process Journal Entry

on:
  repository_dispatch:
    types: [new_journal_entry]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout content
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas pyarrow python-frontmatter
# ... (å‰æ®µ setup ç›¸åŒ) ...

    - name: Run Neural Classifier (Inbox Generation)
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        JOURNAL_TEXT: ${{ github.event.client_payload.text }}
      run: |
        python src/actions/process_inbox.py

    - name: Run Dual-Track Splitter (Auto-Classification)
      run: |
        python src/actions/classify_inbox.py

    - name: Commit All Changes
      run: |
        git config --global user.name "LifeOS Bot"
        git config --global user.email "bot@lifeos.ai"
        git add data/inbox/ data/projects/ data/life/
        git commit -m "ğŸ§  Neural Process: Inbox + Auto-Classification" || exit 0
        git pull --rebase origin main
        git push

    # [NEW] é€™è£¡å°±æ˜¯ã€Œæ¥çƒã€çš„å‹•ä½œ
    - name: Save Payload to Inbox
      if: github.event_name == 'repository_dispatch'
      env:
        PAYLOAD_JSON: '${{ toJson(github.event.client_payload) }}'
      run: |
        import os
        import json
        import datetime
        
        try:
            payload = json.loads(os.environ['PAYLOAD_JSON'])
            content = payload.get('text', '')
            meta = payload.get('metadata', {})
            date = meta.get('date', datetime.datetime.now().strftime('%Y-%m-%d'))
            
            # ç¢ºä¿è³‡æ–™å¤¾å­˜åœ¨
            os.makedirs('data/inbox', exist_ok=True)
            
            # å¯«å…¥ Markdown æª”æ¡ˆ
            filename = f"data/inbox/{date}.md"
            with open(filename, 'w', encoding='utf-8') as f:
                f.write("---\n")
                f.write(f"date: {date}\n")
                f.write(f"mood: {meta.get('mood', 5)}\n")
                f.write("---\n\n")
                f.write(content)
                
            print(f"âœ… Created {filename}")
        except Exception as e:
            print(f"âŒ Error saving payload: {e}")
      shell: python

    - name: Run compaction script
      run: python src/actions/compact_inbox.py

    - name: Commit and push changes
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ğŸ¤– LifeOS: Saved and Organized Entry"
        file_pattern: "data/*"
