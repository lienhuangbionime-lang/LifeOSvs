name: Process Journal Entry

on:
  repository_dispatch:
    types: [new_journal_entry]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # Job 1: ç¢ºä¿è³‡æ–™è½åœ° (æœ€é«˜ç”Ÿå­˜å„ªå…ˆç´š)
  # å³ä½¿å¾ŒçºŒæ­¥é©Ÿå…¨ç‚¸ï¼Œé€™è£¡å·²ç¶“æŠŠ Raw Data é–é€² Git History äº†
  secure_data:
    runs-on: ubuntu-latest
    outputs:
      new_sha: ${{ steps.commit.outputs.sha }}
    steps:
      - name: Checkout content
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install google-generativeai python-frontmatter

      # 1. ç”Ÿæˆ Inbox æª”æ¡ˆ (Gemini Parsing)
      - name: ğŸ§  Neural Intake (Gemini)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          JOURNAL_TEXT: ${{ github.event.client_payload.text }}
        run: python src/actions/process_inbox.py

      # 2. ç«‹åˆ» Commit (é˜²ç¦¦è³‡æ–™éºå¤±)
      - name: Commit Raw Entry
        id: commit
        run: |
          git config --global user.name "LifeOS Bot"
          git config --global user.email "bot@lifeos.ai"
          git add data/inbox/
          git commit -m "ğŸ“ Log Entry: ${{ github.event.client_payload.metadata.date || 'New Entry' }}" || echo "No changes"
          git pull --rebase origin main
          git push
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

  # Job 2: è™•ç†èˆ‡æ­¸æª” (åŸºæ–¼ Job 1 çš„æˆæœ)
  # é€™è£¡çš„å¤±æ•—æ˜¯ã€Œå¯å®¹å¿çš„ã€ï¼Œå› ç‚ºåŸå§‹è³‡æ–™é‚„åœ¨
  process_data:
    needs: secure_data
    runs-on: ubuntu-latest
    steps:
      - name: Checkout content
        uses: actions/checkout@v3
        with:
          ref: ${{ needs.secure_data.outputs.new_sha }} # æ‹‰å– Job 1 å‰› Commit çš„ç‰ˆæœ¬

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install pandas pyarrow python-frontmatter requests google-auth google-api-python-client

      # 3. å°ˆæ¡ˆè‡ªå‹•åˆ†é¡ (Dual-Track Splitter)
      # å¿…é ˆåœ¨ Compaction ä¹‹å‰åŸ·è¡Œ
      - name: ğŸ”€ Run Dual-Track Splitter
        continue-on-error: true # åˆ†é¡å¤±æ•—ä¸æ‡‰é˜»æ­¢æ­¸æª”
        run: python src/actions/classify_inbox.py

      # 4. ä»»å‹™åŒæ­¥ (Sync Tasks) - å¤±æ•—ä¸ä¸­æ–·
      - name: âœ… Sync Tasks (Zapier/Google)
        continue-on-error: true
        env:
          ZAPIER_TASK_WEBHOOK: ${{ secrets.ZAPIER_TASK_WEBHOOK }}
        # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨å†åŸ·è¡Œï¼Œé¿å…å ±éŒ¯
        run: |
          if [ -f "src/actions/sync_tasks.py" ]; then
            python src/actions/sync_tasks.py
          else
            echo "sync_tasks.py not found, skipping."
          fi

      # 5. å ±å‘Šç”Ÿæˆ (Generate Report)
      - name: ğŸ“Š Generate Project Status
        continue-on-error: true
        run: |
          if [ -f "src/actions/generate_report.py" ]; then
            python src/actions/generate_report.py
          else
            echo "generate_report.py not found, skipping."
          fi

      # 6. å£“ç¸®æ­¸æª” (Compaction & Cleanup)
      # å°‡ Inbox è½‰ç‚º Parquet/JSON ä¸¦æ¸…ç©º Inbox
      - name: ğŸ—œï¸ Compaction & Cleanup
        run: python src/actions/compact_inbox.py

      # 7. æäº¤ç³»çµ±ç‹€æ…‹ (System State)
      - name: Commit System State
        run: |
          git config --global user.name "LifeOS Bot"
          git config --global user.email "bot@lifeos.ai"
          git add data/
          git commit -m "âš™ï¸ System Processed & Compacted" || echo "No changes"
          git pull --rebase origin main
          git push
